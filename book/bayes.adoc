//ベイス
ここではベイズ統計モデリングという手法を使って投票データの傾向の説明を試みた結果を書きます。

=== ベイズ統計について

パラメーター

事前分布に対して
パラメーター推定には
データxから
サンプリングすることで分布(事後分布)を推定します。

=== 言語とツール

ここではpythonのライブラリpystanを用いてモデルの記述をします。stanは統計モデリングを
他にもpythonのライブラリpymcを用いる方法もあり、
ますが、推論で使われる内部的な計算は変わりありません。

事後分布の可視化にはarvizというライブラリを使います。

=== モデリングと結果

このようにデータをグループ分けするモデルは階層モデルと呼ばれます。今回のキャラとそれが登場した整数作品のような階層的な関係が実際にある場合に自然な過程となります。
データの分布の観点からは階層モデルはデータのばらつきが　過分散と呼ばれる問題に対処できると


==== キャラクター

が初登場の作品に

- 和モデル
//hyper dth[i]=sum(mains)+sum(bosses)+sum(subs)+hifuu+book+misc+indivisual[i];

stem:[
 normVote_{i,t} \sim Dir(\sum_{l=1}^{TM} main_{j(i,t-l),t-l} \sigma_{j,l} \\ + \sum_{l=1}^{TM} boss_{j(i,t-1),t-l}Lv_i b_{j(i,t-l),l} 
 +\sum_{l=1}^{TM} sub_{j(i,t-l)} s_{j,l}+\epsilon_i
 )
]

Dirというのはディリクレ分布で各要素の合計が1になるようなベクトルに値を持つ確率分布関数です。正規化した投票結果に対して用いることができます。Dirのパラメーターは
 - 整数作品の登場キャラ
 - 整数作品のボスキャラ
 - 非整数作品
 - 秘封倶楽部、その他

で構成されます。非整数作品でのみ登場するキャラと再登場キャラは区別していませんが、

別のモデルとして投票期間によらない作品の影響力を加えたモデル

も考えられます。結果として計算された事後分布は以下のようになります。

image::img/music_posterior_trace_harm_hyper.png[width=40%][width=40%]

ベクトルのパラメーターは各要素を重ね合わせて描いています。

image::img/music_posterior_charm_hyper.png[width=40%][width=40%]

特にindivisualの影響が大きく紅魔郷が強いこと、　などがそこに現れています。
以下のモデルを考えます。

- 和モデル(旧作、秘封、その他に時間依存性を入れた場合)

//sumnidivisual dth[i]=(sum(mains)+sum(bosses)+titlebase+sum(subs) +noninttitlebase +sum(hifuu)+sum(book)+sum(misc))+indivisual[i];
stem:[
 normVote_{i,t} \sim Dir(\sum_{l=1}^{TM} main_{j(i,t-l),t-l} \sigma_{j,l} \\ + \sum_{l=1}^{TM} boss_{j(i,t-1),t-l}Lv_i b_{j(i,t-l),l} 
 +\sum_{l=1}^{TM} sub_{j(i,t-l)} s_{j,l}+\epsilon_i
 )
]

image::img/posterior_charm_sum.png[width=40%][width=40%]

最初の和モデルと同様にindivisualの影響が強く、タイトルによる影響はあまり見えませんでした。

- 積和モデル

indivisualの影響を
が強く、タイトルによる影響はあまり見えませんでした。

stem:[
 normVote_{i,t} \sim Dir( (\sum_{l=1}^{TM} main_{j(i,t-l),t-l} \sigma_{j,l} \\ + \sum_{l=1}^{TM} boss_{j(i,t-1),t-l}Lv_i b_{j(i,t-l),l} 
 +\sum_{l=1}^{TM} sub_{j(i,t-l)} s_{j,l})*\epsilon_i
 )
]

image::img/posterior_charm_sumprod.png[width=40%][width=40%]

収束せず事後分布はバラバラになってしまいました。

==== 音楽

キャラと同様に和モデル、積和モデルを考えます。違いは旧作、秘封倶楽部が大きな割合を占めていることでそこでは登場順序はあまり重要ではないという仮定をしています。また再録曲の情報は用いませんでした。実際には人気に影響が
計算上の特性である属性に含まれるかどうかというflagをdataframeとして持っておく方が計算が高速化することがわかりました。

- 和モデル

image::img/music_posterior_charm_sum.png[width=40%][width=40%]

- 積和モデル

このモデルはキャラクターの方とは異なり収束しました。

image::img/music_posterior_charm_sumprod.png[width=40%][width=40%]

==== 事前分布

パラメーターに加えられる仮定である事前分布は計算の収束に大きな影響を与えます。stanでは事前分布を指定しない場合は一様分布が用いられますが、無限の区間幅を持つため現実的ではありません。現実的な範囲内に
正規分布があるいはパラメータが正の値を持つという仮定を置くのであれば指数分布、整数のパラメーターに対しては対してはポアッソン分布などが用いられます。
「StanとRでベイズ統計モデリング」にも書かれており、逆ガンマ分布あるいは半コーシー分布という裾の広い分布関数を使用すると良いとされています。stanでは

==== 別の観点

上ではキャラクター、音楽を主体としたモデリングをしましたが、投票者の行動に基づいたモデリングも考えられます。

=== 発展的話題

- 因果推論

非整数作品での再登場、再録はその時点までの人気で決定されていると考えられます。

- 情報量基準

- 他のデータの利用
